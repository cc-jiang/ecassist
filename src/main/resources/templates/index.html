<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>

    <!--引入 element-ui 的样式，-->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.14/theme-chalk/index.css">
    <!-- 引入vue -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.7.14/vue.js"></script>
    <!-- 引入element 的组件库-->
    <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.14/index.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.5.0/axios.min.js"></script>

    <meta charset="UTF-8">
    <title>生成模板</title>
</head>
<body>

<div id="app">

    <el-form :model="genGoodsTemplate" label-width="80px" style="">

        <el-row>
            <el-col :span="8">
                <el-form-item label="操作">
                    <el-button type="primary" @click="genGoodsTemplateFiles()">生成文件</el-button>
                    <el-button type="info" @click="reload()">重新加载模板</el-button>
                </el-form-item>
            </el-col>
        </el-row>

        <el-row>
            <el-col :span="8">
                <el-form-item label="路径">
                    <el-input v-model="genGoodsTemplate.path" style=""></el-input>
                </el-form-item>
            </el-col>
        </el-row>

        <el-row>
            <el-col :span="8">
                <el-form-item label="生成模式">
                    <el-select v-model="genGoodsTemplate.genType" placeholder="请选择">
                        <el-option
                                v-for="item in genTypeList"
                                :key="item.value"
                                :label="item.label"
                                :value="item.value">
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-col>
        </el-row>

        <el-row>
            <el-col :span="8">
                <el-form-item label="类目">
                    <el-select v-model="genGoodsTemplate.productCategory" placeholder="请选择">
                        <el-option
                                v-for="item in productCategoryList"
                                :key="item"
                                :label="item"
                                :value="item">
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-col>
        </el-row>

        <el-row>
            <el-col :span="8">
                <el-form-item label="型号">
                    <el-select @change="selectModel" v-model="genGoodsTemplate.modelList" placeholder="请选择"
                               filterable multiple>
                        <el-option
                                v-for="item in modelList"
                                :key="item.code"
                                :label="item.code"
                                :value="item.code">
                            <span style="float: left">{{ item.code }}</span>
                            <span style="float: right; color: #8492a6; font-size: 13px">{{ item.versionNo }}</span>
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-col>
        </el-row>

        <el-row>
            <el-col :span="8">
                <el-form-item label="关键词">
                    <el-button size="mini" type="success" @click="selectKeyword()">选择</el-button>
                </el-form-item>
            </el-col>
        </el-row>

    </el-form>

<!--    <el-table-->
<!--            :data="productList"-->
<!--            style="width: 100%">-->
<!--        <el-table-column-->
<!--                label="货号"-->
<!--                width="300">-->
<!--            <template slot-scope="scope">-->
<!--                <i class="el-icon-time"></i>-->
<!--                <span style="margin-left: 10px">{{ scope.row.productName }}</span>-->
<!--            </template>-->
<!--        </el-table-column>-->
<!--        <el-table-column-->
<!--                label="型号"-->
<!--                width="180">-->
<!--            <template slot-scope="scope">-->
<!--                <el-select @change="selectModel(scope.row)" v-model="scope.row.modelList" placeholder="请选择"-->
<!--                           filterable multiple>-->
<!--                    <el-option-->
<!--                            v-for="item in modelList"-->
<!--                            :key="item.code"-->
<!--                            :label="item.code"-->
<!--                            :value="item.code">-->
<!--                        <span style="float: left">{{ item.code }}</span>-->
<!--                        <span style="float: right; color: #8492a6; font-size: 13px">{{ item.versionNo }}</span>-->
<!--                    </el-option>-->
<!--                </el-select>-->
<!--            </template>-->
<!--        </el-table-column>-->
<!--        <el-table-column-->
<!--                label="类目"-->
<!--                width="180">-->
<!--            <template slot-scope="scope">-->
<!--                <el-select v-model="scope.row.productCategory" placeholder="请选择">-->
<!--                    <el-option-->
<!--                            v-for="item in productCategoryList"-->
<!--                            :key="item"-->
<!--                            :label="item"-->
<!--                            :value="item">-->
<!--                    </el-option>-->
<!--                </el-select>-->
<!--            </template>-->
<!--        </el-table-column>-->
<!--        <el-table-column label="操作">-->
<!--            <template slot-scope="scope">-->
<!--                <el-button size="mini" type="success" @click="selectKeyword(scope.$index)">关键词</el-button>-->
<!--                <el-button size="mini" type="danger" @click="handleDelete(scope.$index)">删除</el-button>-->
<!--            </template>-->
<!--        </el-table-column>-->
<!--    </el-table>-->


    <el-dialog
            title="选择关键词"
            :visible.sync="keywordVisible"
            width="30%">
        <el-checkbox :indeterminate="isIndeterminate" v-model="checkAll" @change="handleCheckAllChange">全选</el-checkbox>
        <div style="margin: 15px 0;"></div>
        <el-checkbox-group v-model="genGoodsTemplate.keywordList" @change="handleCheckedKeywordChange">
            <el-checkbox v-for="item in keywordList" :label="item" :key="item">{{ item }}</el-checkbox>
        </el-checkbox-group>
        <span slot="footer" class="dialog-footer">
            <el-button @click="keywordVisible = false">取 消</el-button>
            <el-button type="primary" @click="keywordVisible = false">确 定</el-button>
        </span>
    </el-dialog>

</div>

</body>

<script>
    axios.defaults.headers['Content-Type'] = 'application/json;charset=utf-8';
    const request = axios.create({
        // axios中请求配置有baseURL选项，表示请求URL公共部分
        // baseURL: 'http://localhost:8081',
        // 超时
        timeout: 10000
    });
    new Vue({
        el: '#app',
        data: {
            // dialog
            keywordVisible: false,

            // 全选框
            isIndeterminate: false,
            checkAll: false,

            keywordSelected: [],

            genGoodsTemplate: {
                path: '',
                genType: 1,
                productCategory: '',
                modelList: [],
                versionNoList: [],
                keywordList: []
            },

            templateList: [],
            genTypeList: [{value: 1, label: '单型号模式'}, {value: 2, label: '多型号模式'}],
            modelList: [],
            keywordList: [],
            productCategoryList: [],

            modelByCode: null,

            productList: [],
            list: []
        },
        created() {
            request.interceptors.response.use(res => {
                    // 未设置状态码则默认成功状态
                    const code = res.data.code || 200;
                    // 获取错误信息
                    const msg = res.data.msg;
                    // 二进制数据则直接返回
                    if (res.request.responseType ===  'blob' || res.request.responseType ===  'arraybuffer') {
                        return res.data;
                    }
                    if (code === 500) {
                        this.$message.error(msg);
                        return Promise.reject(new Error(msg));
                    } else if (code !== 200) {
                        Notification.error({ title: msg })
                        return Promise.reject('error');
                    } else {
                        return res.data;
                    }
                },
                error => {
                    console.log('err' + error);
                    this.$message.error(error);
                    return Promise.reject(error);
                }
            );
            this.load();
        },
        methods: {
            reload() {
                location.reload();
            },
            load() {
                request({
                    url: '/goodsTemplate/getDefaultPath',
                    method: 'get'
                }).then(res => {
                    this.genGoodsTemplate.path = res.data;
                });
                request({
                    url: '/goodsTemplate/getModelList',
                    method: 'get'
                }).then(res => {
                    this.modelList = res.data;
                    this.modelByCode = this.modelList.reduce((map, e) => {
                        map.set(e.code, e);
                        return map;
                    }, new Map());
                });
                request({
                    url: '/goodsTemplate/getKeywordList',
                    method: 'get'
                }).then(res => {
                    this.keywordList = res.data.map(keyword => keyword.name);
                    this.productCategoryList = [...new Set(res.data.map(keyword => keyword.productCategory))];
                    this.genGoodsTemplate.productCategory = this.productCategoryList[0];
                });
            },
            selectModel() {
                this.genGoodsTemplate.versionNoList = [...new Set(this.genGoodsTemplate.modelList.map(model => this.modelByCode.get(model).versionNo))];
            },
            genGoodsTemplateFiles() {
                for (let i = 0; i < this.productList.length; i++) {
                    if (this.genGoodsTemplate.modelList === 0) {
                        this.$message.error('请选择型号');
                        return;
                    }
                    if (!this.genGoodsTemplate.productCategory) {
                        this.$message.error('请选择类目');
                        return;
                    }
                    if (this.genGoodsTemplate.keywordList.length === 0) {
                        this.$message.error('请选择关键词');
                        return;
                    }
                }
                request({
                    url: '/goodsTemplate/genGoodsTemplateFiles',
                    method: 'post',
                    data: this.genGoodsTemplate
                }).then(res => {
                    if (res.code === 200) {
                        this.$message.success(res.msg);
                    }
                });
            },
            selectKeyword() {
                this.keywordVisible = true;
            },
            handleCheckAllChange(val) {
                this.genGoodsTemplate.keywordList = val ? this.keywordList : [];
                this.isIndeterminate = false;
            },
            handleCheckedKeywordChange(value) {
                let checkedCount = value.length;
                this.checkAll = checkedCount === this.keywordList.length;
                this.isIndeterminate = checkedCount > 0 && checkedCount < this.keywordList.length;
            },
            handleDelete(index) {
                this.productList.splice(index, 1);
            }
        }
    });
</script>
</html>